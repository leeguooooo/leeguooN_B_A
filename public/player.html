<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #fff;
        }
        .player-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        .controls {
            padding: 20px;
            background: #222;
        }
        .url-input {
            width: 70%;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: #fff;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #28a745;
        }
        .status.error {
            background: #dc3545;
        }
        .test-streams {
            margin-top: 20px;
        }
        .test-stream {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }
        .test-stream:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLS ç›´æ’­æ’­æ”¾å™¨</h1>
        
        <div class="player-container">
            <video id="video" controls></video>
            
            <div class="controls">
                <input type="text" id="streamUrl" class="url-input" placeholder="è¾“å…¥ m3u8 æµåœ°å€">
                <button onclick="loadStream()" class="btn">æ’­æ”¾</button>
                <div id="status"></div>
                
                <div class="test-streams">
                    <h3>æµ‹è¯•æµåœ°å€ï¼š</h3>
                    <a href="#" class="test-stream" onclick="loadTestStream('https://v4-883f0cd13cae4b9414b1c6ed244aad5f.livehwc4.com/hdl7.szsummer.cn/live/17984472.m3u8?edge_slice=true&user_session_id=7c232a0c4d036f2e35b2cba4f9a45ae6&sub_m3u8=true&auth_key=1749744000-ddf9c5e90eba4cca8b4acf6a60c4d8b2-0-6b768444bbbb4e788243166e509ff231')">
                        ğŸ¯ CDNç›´æ’­æµ (å¯ç”¨) - livehwc4.com
                    </a>
                    <a href="#" class="test-stream" onclick="testLatestStream()">
                        å®æ—¶è·å–æœ€æ–°æµåœ°å€ (API + ä»£ç†)
                    </a>
                    <a href="#" class="test-stream" onclick="loadTestStream('http://localhost:3000/api/getIframeSrc?url=http%3A%2F%2Fplay.xndezx.com%2Fplay%2Fsm.html%3Fid%3D265%26id2%3D')">
                        æµ‹è¯•API: localhost:3000/api/getIframeSrc?url=...
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');
        let hls;

        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function loadStream() {
            const url = document.getElementById('streamUrl').value.trim();
            if (!url) {
                showStatus('è¯·è¾“å…¥æµåœ°å€', 'error');
                return;
            }
            
            playStream(url);
        }

        function loadTestStream(url) {
            document.getElementById('streamUrl').value = url;
            
            // å¦‚æœæ˜¯APIåœ°å€ï¼Œå…ˆè·å–çœŸå®çš„æµåœ°å€
            if (url.includes('/api/getIframeSrc')) {
                showStatus('æ­£åœ¨è·å–æµåœ°å€...', 'info');
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.url) {
                            // ä»åµŒå¥—çš„iframeä¸­æå–m3u8åœ°å€
                            const m3u8Match = data.url.match(/id=([^&]+)/);
                            if (m3u8Match) {
                                let m3u8Url = decodeURIComponent(m3u8Match[1]);
                                if (m3u8Url.startsWith('//')) {
                                    m3u8Url = 'https:' + m3u8Url;
                                }
                                document.getElementById('streamUrl').value = m3u8Url;
                                playStream(m3u8Url);
                            } else {
                                showStatus('æ— æ³•è§£ææµåœ°å€', 'error');
                            }
                        } else {
                            showStatus('APIè¿”å›é”™è¯¯: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    })
                    .catch(error => {
                        showStatus('è·å–æµåœ°å€å¤±è´¥: ' + error.message, 'error');
                    });
            } else {
                playStream(url);
            }
        }

        function playStream(url) {
            showStatus('æ­£åœ¨åŠ è½½æµ...', 'info');
            
            // æ¸…ç†ä¹‹å‰çš„HLSå®ä¾‹
            if (hls) {
                hls.destroy();
            }

            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    showStatus('æµåŠ è½½æˆåŠŸï¼Œå¼€å§‹æ’­æ”¾', 'success');
                    video.play();
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLSé”™è¯¯:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showStatus('ç½‘ç»œé”™è¯¯ï¼Œå°è¯•æ¢å¤...', 'error');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showStatus('åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤...', 'error');
                                hls.recoverMediaError();
                                break;
                            default:
                                showStatus('æ— æ³•æ¢å¤çš„é”™è¯¯: ' + data.details, 'error');
                                hls.destroy();
                                break;
                        }
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // SafariåŸç”Ÿæ”¯æŒ
                video.src = url;
                showStatus('ä½¿ç”¨åŸç”ŸHLSæ”¯æŒ', 'success');
            } else {
                showStatus('æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾', 'error');
            }
        }

        function testLatestStream() {
            showStatus('æ­£åœ¨è·å–æœ€æ–°æµåœ°å€...', 'info');
            
            // ä½¿ç”¨getStreamUrl APIè·å–æœ€æ–°çš„æµåœ°å€
            fetch('/api/getStreamUrl?url=' + encodeURIComponent('http://play.xndezx.com/play/sm.html?id=265&id2='))
                .then(response => response.json())
                .then(data => {
                    if (data.streamUrl) {
                        console.log('è·å–åˆ°æµåœ°å€:', data.streamUrl);
                        // ä½¿ç”¨ä»£ç†æ’­æ”¾
                        const proxyUrl = '/proxy/m3u8?url=' + encodeURIComponent(data.streamUrl);
                        document.getElementById('streamUrl').value = proxyUrl;
                        playStream(proxyUrl);
                    } else {
                        showStatus('è·å–æµåœ°å€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                })
                .catch(error => {
                    showStatus('APIè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                });
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const liveUrl = urlParams.get('url');
            
            if (liveUrl) {
                showStatus('æ­£åœ¨è·å–æµåœ°å€...', 'info');
                // ä½¿ç”¨ getStreamUrl API è·å–æµåœ°å€
                fetch('/api/getStreamUrl?url=' + encodeURIComponent(liveUrl))
                    .then(response => response.json())
                    .then(data => {
                        if (data.streamUrl) {
                            console.log('è·å–åˆ°æµåœ°å€:', data.streamUrl);
                            // ä½¿ç”¨ä»£ç†æ’­æ”¾ï¼Œé¿å…CORSé—®é¢˜
                            const proxyUrl = '/proxy/m3u8?url=' + encodeURIComponent(data.streamUrl);
                            document.getElementById('streamUrl').value = proxyUrl;
                            playStream(proxyUrl);
                        } else {
                            showStatus('è·å–æµåœ°å€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    })
                    .catch(error => {
                        showStatus('APIè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                    });
            } else {
                showStatus('æ’­æ”¾å™¨å·²å°±ç»ªï¼Œè¾“å…¥m3u8åœ°å€å¼€å§‹æ’­æ”¾', 'info');
            }
        });
    </script>
</body>
</html>